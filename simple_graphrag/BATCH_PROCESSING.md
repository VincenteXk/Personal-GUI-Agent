# Pipeline V2 批量处理文本

## 功能说明

Pipeline V2 现在支持输入**文本列表**，对每个文本依次执行完整的增量更新流程。

## 核心特性

### 1. 单次初始化

- **System 加载**：只在开始时加载一次预定义 System
- **Graph 创建**：只在开始时创建一次 Graph（含预定义实体）

### 2. 增量更新

对每个文本都执行：

1. **SystemUpdater**：检查并增量扩展 System
2. **GraphExtractor**：提取实体和关系
3. **Combiner**：融合到 Graph（去重、增量、校验）

### 3. 累积效果

- 所有更新都累积在**同一个 Graph** 上
- System 会随着文本的处理**逐步扩展**（如果需要）
- 实体和关系会**去重和合并**

## 使用方法

### 方式1：单个文本

```python
from pipeline_v2 import PipelineV2

pipeline = PipelineV2("config/config.yaml")

# 单个文本
text = "我在小红书上看到一个AI绘图的视频。"
graph = pipeline.run(text, visualize=True)

print(f"实体: {graph.get_entity_count()} 个")
print(f"关系: {graph.get_relationship_count()} 个")
```

### 方式2：文本列表（推荐）

```python
from pipeline_v2 import PipelineV2

pipeline = PipelineV2("config/config.yaml")

# 文本列表
texts = [
    "我在小红书上看到一个AI绘图的视频，用微信分享给了朋友。",
    "我在Bilibili上看到书籍介绍，便在淘宝上购买了一本。",
    "我经常在抖音和快手上刷短视频。",
]

# 批量处理（增量更新）
graph = pipeline.run(texts, visualize=True)

print(f"最终统计:")
print(f"  实体: {graph.get_entity_count()} 个")
print(f"  关系: {graph.get_relationship_count()} 个")
print(f"  类: {len(graph.system.get_all_classes())} 个")
```

## 工作流程

```
┌─────────────────────────────────────────────────────────┐
│ Step 1: 加载预定义 System 和创建 Graph（只执行一次）    │
│   - 从 config.yaml 加载 base_system                     │
│   - 创建 Graph，自动注入预定义实体                       │
└─────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────┐
│ 循环处理每个文本：                                       │
│                                                         │
│ ┌───────────────────────────────────────────────────┐ │
│ │ 文本 1:                                           │ │
│ │   → SystemUpdater: 检查并扩展 System             │ │
│ │   → GraphExtractor: 提取实体和关系               │ │
│ │   → Combiner: 融合到 Graph                       │ │
│ └───────────────────────────────────────────────────┘ │
│                                                         │
│ ┌───────────────────────────────────────────────────┐ │
│ │ 文本 2:                                           │ │
│ │   → SystemUpdater: 检查并扩展 System             │ │
│ │   → GraphExtractor: 提取实体和关系               │ │
│ │   → Combiner: 融合到 Graph                       │ │
│ └───────────────────────────────────────────────────┘ │
│                                                         │
│ ┌───────────────────────────────────────────────────┐ │
│ │ 文本 N:                                           │ │
│ │   → SystemUpdater: 检查并扩展 System             │ │
│ │   → GraphExtractor: 提取实体和关系               │ │
│ │   → Combiner: 融合到 Graph                       │ │
│ └───────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────┐
│ Step 5: 保存和可视化（只执行一次）                      │
│   - 保存 Graph（包含扩展后的 system）                   │
│   - 生成可视化 HTML                                     │
└─────────────────────────────────────────────────────────┘
```

## 日志输出示例

```
============================================================
Pipeline V2 开始运行
============================================================
输入文本数量: 3 个

============================================================
步骤1: 加载预定义 System
============================================================
加载 System: 8 个类
类列表: ['用户', '可启动应用', '购物平台', ...]
预定义实体: 9 个
Graph 创建完成: 9 个实体（含预定义）

============================================================
处理文本 1/3
============================================================
文本内容: 我在小红书上看到一个AI绘图的视频...

============================================================
步骤2: 检查并增量扩展 System
============================================================
System 无需扩展
当前 System 包含 8 个类

============================================================
步骤3: 提取实体和关系
============================================================
提取完成: 3 个实体, 2 个关系

============================================================
步骤4: 融合实体和关系到 Graph
============================================================
融合完成:
  实体: 新增 1, 更新 2, 失败 0
  关系: 新增 2, 更新 0, 失败 0
当前 Graph: 10 个实体, 2 个关系

文本 1 处理完成，当前 Graph: 10 个实体, 2 个关系

============================================================
处理文本 2/3
============================================================
文本内容: 我在Bilibili上看到书籍介绍...

... (继续处理后续文本)

============================================================
Pipeline V2 运行完成
最终统计: 12 个实体, 5 个关系
============================================================
```

## 优势

### 1. 内存效率

- 不需要为每个文本创建新的 Graph
- System 和 Graph 在内存中只有一份

### 2. 上下文保持

- System 的扩展在所有文本间**共享**
- 后续文本可以使用前面文本扩展的类定义
- 实体去重避免重复创建（如"小红书"只创建一次）

### 3. 增量学习

- System 逐步学习新的概念（类定义）
- Graph 逐步积累实体和关系
- 适合**流式处理**大量文本

## 注意事项

### 1. 文本顺序

如果文本之间有依赖关系，建议按**时间或逻辑顺序**排列：

```python
# 好的顺序
texts = [
    "我在淘宝上注册了账号。",         # 先介绍淘宝
    "我在淘宝上购买了一本书。",        # 再描述使用
    "我推荐朋友也使用淘宝购物。",      # 最后是关系
]
```

### 2. System 扩展

- System 扩展是**单调的**（只能增加，不能删除）
- 如果某个文本引入了错误的类定义，后续文本无法撤销
- 建议先用**少量文本**测试 System 扩展逻辑

### 3. 去重逻辑

- 实体去重基于**名称**（不区分大小写）
- 如果两个文本提到同一实体但描述不同，会**合并描述**
- 关系去重基于 **(源实体, 目标实体, 描述)** 三元组

## 测试

### 运行批量处理测试

```bash
python test_batch_processing.py
```

**输出示例**：

```
============================================================
测试：Pipeline V2 批量处理文本列表
============================================================

1. 加载预定义 System
   类: 8 个
   预定义实体: 9 个

2. 创建 Graph（包含预定义实体）
   实体: 9 个

3. 批量处理 3 个文本

   处理文本 1/3
   内容: 文本1：我在小红书上看到一个AI绘图的视频。
   当前 Graph: 9 个实体

   处理文本 2/3
   内容: 文本2：我在Bilibili上看到书籍介绍，便在淘宝上购买了。
   → 新增实体: Bilibili
   → 使用已有实体: 淘宝（预定义）
   当前 Graph: 11 个实体

   处理文本 3/3
   内容: 文本3：我经常在抖音和快手上刷短视频。
   当前 Graph: 11 个实体

============================================================
最终统计
============================================================
System 类: 8 个
Graph 实体: 11 个
Graph 关系: 0 个

测试通过：支持批量处理文本列表
============================================================
```

## 与单文本处理的对比

| 特性 | 单文本 | 文本列表 |
|------|--------|---------|
| System 加载 | 每次 | 一次 |
| Graph 创建 | 每次 | 一次 |
| System 扩展 | 孤立 | 累积 |
| 实体去重 | 否 | 是 |
| 内存占用 | 多份 Graph | 一份 Graph |
| 适用场景 | 单个查询 | 批量导入、流式处理 |

## 完整示例

参见 `pipeline_v2.py` 的 `main()` 函数：

```python
def main():
    config_path = PROJECT_ROOT / "config" / "config.yaml"

    # 示例输入文本
    input_texts = [
        "我在小红书上看到一个AI绘图的视频，用微信分享给了朋友。",
        "我在Bilibili上看到书籍介绍，便在淘宝上购买了一本。",
    ]

    pipeline = PipelineV2(config_path)
    
    # 处理文本列表（增量更新）
    graph = pipeline.run(input_texts, visualize=True)

    print(f"实体: {graph.get_entity_count()} 个")
    print(f"关系: {graph.get_relationship_count()} 个")
    print(f"类: {len(graph.system.get_all_classes())} 个")
```

## 未来扩展

可能的增强方向：

1. **并行处理**：对独立文本并行提取，然后统一融合
2. **流式 API**：支持生成器输入，逐个处理
3. **检查点保存**：每处理 N 个文本保存一次 Graph
4. **回滚机制**：如果某个文本处理失败，回滚到上一个状态
