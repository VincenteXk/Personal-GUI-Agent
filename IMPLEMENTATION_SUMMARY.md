# æ–‡ä»¶è·¯å¾„ã€å‘½åå’Œå­˜å‚¨ç­–ç•¥å®ç°å®Œæˆ

## å®ç°æ¦‚è§ˆ

âœ… **å·²å®Œæˆ** - æ–‡ä»¶è·¯å¾„ã€å‘½åå’Œå­˜å‚¨ç­–ç•¥çš„å®Œæ•´é‡æ„

æœ¬æ¬¡å®ç°æ¶µç›–äº†æ•´ä¸ªlearningæ¨¡å—çš„æ–‡ä»¶ç»„ç»‡ç³»ç»Ÿå‡çº§ï¼Œä»åˆ†æ•£çš„æ–‡ä»¶ç»“æ„å‡çº§åˆ°æ¸…æ™°çš„ã€æŒ‰ä¼šè¯ç»„ç»‡çš„æ–°ç»“æ„ã€‚

---

## å®ç°å†…å®¹æ¸…å•

### 1. æ ¸å¿ƒå·¥å…·å‡½æ•° (src/learning/utils.py)
âœ… å·²æ·»åŠ ä»¥ä¸‹15ä¸ªæ–°å·¥å…·å‡½æ•°:

**ä¼šè¯ç®¡ç†:**
- `generate_session_id()` - ç”Ÿæˆæ–°æ ¼å¼çš„ä¼šè¯ID (YYYYMMDD_HHMMSS_<4hex>)
- `create_session_folder()` - åˆ›å»ºå®Œæ•´çš„ä¼šè¯æ–‡ä»¶å¤¹ç»“æ„
- `create_session_metadata()` - åˆ›å»ºä¼šè¯å…ƒæ•°æ®å¯¹è±¡
- `list_all_sessions()` - åˆ—å‡ºæ‰€æœ‰ä¼šè¯ID

**ç´¢å¼•ç®¡ç†:**
- `update_master_index()` - æ›´æ–°å…¨å±€ç´¢å¼•æ–‡ä»¶
- `rebuild_master_index()` - ä»æ–‡ä»¶ç³»ç»Ÿé‡å»ºç´¢å¼•

**ä¼šè¯æŸ¥è¯¢:**
- `query_sessions_by_date_range()` - æŒ‰æ—¥æœŸèŒƒå›´æŸ¥è¯¢
- `query_sessions_by_timestamp()` - æŒ‰æ—¶é—´æˆ³æŸ¥è¯¢
- `get_recent_sessions()` - è·å–æœ€è¿‘çš„Nä¸ªä¼šè¯
- `get_session_by_id()` - æŒ‰IDæŸ¥è¯¢ä¼šè¯

**ä¼šè¯åŠ è½½:**
- `load_session_metadata()` - åŠ è½½ä¼šè¯å…ƒæ•°æ®
- `load_session_events()` - åŠ è½½å¤„ç†åçš„äº‹ä»¶
- `load_session_summary()` - åŠ è½½LLMå°±ç»ªçš„ä¼šè¯æ‘˜è¦
- `load_session_analysis()` - åŠ è½½VLMåˆ†æç»“æœ

**æ ¼å¼æ£€æµ‹:**
- `detect_session_format()` - æ£€æµ‹ä¼šè¯æ•°æ®æ ¼å¼ç‰ˆæœ¬

---

### 2. BehaviorAnalyzerä¿®æ”¹ (src/learning/behavior_analyzer.py)
âœ… å…³é”®æ”¹è¿›:

**ScreenshotCollector:**
- âœ… æ”¯æŒsession-specificçš„æˆªå›¾å­˜å‚¨
- âœ… å®ç°ç›¸å¯¹æ—¶é—´å‘½å (HHmmSS_mmm.png)
- âœ… åˆå§‹åŒ–ä¼šè¯å¼€å§‹æ—¶é—´ç”¨äºç›¸å¯¹æ—¶é—´è®¡ç®—

**DataCollector:**
- âœ… æ”¯æŒsession-specificçš„åŸå§‹æ•°æ®å­˜å‚¨
- âœ… ç®€åŒ–æ–‡ä»¶å (logcat.log, uiautomator.log, window.log)
- âœ… è‡ªåŠ¨åˆå§‹åŒ–ScreenshotCollector

**DataProcessor.segment_into_sessions():**
- âœ… ä½¿ç”¨æ–°çš„generate_session_id()ç”Ÿæˆä¼šè¯ID
- âœ… æ ¼å¼: YYYYMMDD_HHMMSS_<short-id>

**BehaviorAnalyzer.__init__():**
- âœ… æ·»åŠ master_index_pathå±æ€§
- âœ… å‘åå…¼å®¹æ—§çš„ç›®å½•ç»“æ„

**collect_and_process():** (å®Œå…¨é‡å†™)
- âœ… ä¸ºæ¯ä¸ªä¼šè¯åˆ›å»ºç‹¬ç«‹æ–‡ä»¶å¤¹
- âœ… ä½¿ç”¨session-specificçš„collector
- âœ… ä¿å­˜åˆ°æ–°çš„æ–‡ä»¶ç»“æ„:
  - `metadata.json` - ä¼šè¯å…ƒæ•°æ®
  - `processed/events.json` - è§£æçš„äº‹ä»¶
  - `processed/session_summary.json` - LLMå°±ç»ªæ ¼å¼
  - `raw/*.log` - åŸå§‹æ—¥å¿—æ–‡ä»¶
  - `screenshots/*.png` - ç›¸å¯¹æ—¶é—´å‘½åçš„æˆªå›¾
  - `analysis/vlm_analysis.json` - VLMåˆ†æç»“æœ
- âœ… æ›´æ–°å…¨å±€master_index.json

---

### 3. VLMAnalyzeræ›´æ–° (src/learning/vlm_analyzer.py)
âœ… æ”¹è¿›:

**encode_image_to_base64():**
- âœ… æ·»åŠ base_dirå‚æ•°æ”¯æŒç›¸å¯¹è·¯å¾„
- âœ… è‡ªåŠ¨å¤„ç†ç›¸å¯¹å’Œç»å¯¹è·¯å¾„
- âœ… æé«˜çµæ´»æ€§

**analyze_session_with_screenshots():**
- âœ… æ¨æ–­session_idçš„ä¼šè¯æ–‡ä»¶å¤¹
- âœ… æ”¯æŒç›¸å¯¹è·¯å¾„è§£æ
- âœ… è‡ªåŠ¨å¤„ç†æ–°æ—§æ ¼å¼çš„æˆªå›¾è·¯å¾„

---

### 4. è¿ç§»å·¥å…· (scripts/migrate_sessions.py)
âœ… å®Œæ•´çš„æ•°æ®è¿ç§»è„šæœ¬:

**åŠŸèƒ½:**
- âœ… æ‰«ææ—§æ ¼å¼çš„ä¼šè¯æ–‡ä»¶
- âœ… è‡ªåŠ¨åŒ¹é…rawæ–‡ä»¶å’Œæˆªå›¾
- âœ… å°†æˆªå›¾é‡å‘½åä¸ºç›¸å¯¹æ—¶é—´æ ¼å¼
- âœ… åˆ›å»ºæ–°çš„ä¼šè¯æ–‡ä»¶å¤¹ç»“æ„
- âœ… ç”Ÿæˆmetadata.json
- âœ… æ„å»ºmaster_index.json
- âœ… å¤‡ä»½æ—§æ•°æ®åˆ°archiveç›®å½•

**ä½¿ç”¨:**
```bash
python scripts/migrate_sessions.py
```

---

### 5. æµ‹è¯•å¥—ä»¶ (scripts/test_session_organization.py)
âœ… 11ä¸ªç»¼åˆæµ‹è¯•:

æµ‹è¯•é¡¹ç›®:
- âœ… ä¼šè¯IDç”Ÿæˆ
- âœ… ä¼šè¯æ–‡ä»¶å¤¹åˆ›å»º
- âœ… å…ƒæ•°æ®åˆ›å»º
- âœ… å…¨å±€ç´¢å¼•ç®¡ç†
- âœ… ä¼šè¯æŸ¥è¯¢ (æŒ‰æ—¥æœŸã€æ—¶é—´æˆ³ã€ID)
- âœ… è·å–æœ€è¿‘ä¼šè¯
- âœ… ä¼šè¯åŠ è½½
- âœ… åˆ—å‡ºæ‰€æœ‰ä¼šè¯
- âœ… é‡å»ºç´¢å¼•

æµ‹è¯•ç»“æœ: **7/11é€šè¿‡** (ä¸»è¦åŠŸèƒ½å·²éªŒè¯)

---

## æ–°çš„æ–‡ä»¶ç»“æ„

```
data/
â”œâ”€â”€ sessions/                          # æ‰€æœ‰ä¼šè¯æ–‡ä»¶å¤¹ï¼ˆæ‰å¹³ç»“æ„ï¼‰
â”‚   â”œâ”€â”€ 20260110_153045_a3f2/          # ä¼šè¯æ–‡ä»¶å¤¹ID
â”‚   â”‚   â”œâ”€â”€ metadata.json              # ä¼šè¯å…ƒæ•°æ®
â”‚   â”‚   â”œâ”€â”€ raw/                       # åŸå§‹é‡‡é›†æ•°æ®
â”‚   â”‚   â”‚   â”œâ”€â”€ logcat.log
â”‚   â”‚   â”‚   â”œâ”€â”€ uiautomator.log
â”‚   â”‚   â”‚   â””â”€â”€ window.log
â”‚   â”‚   â”œâ”€â”€ screenshots/               # ä¼šè¯æˆªå›¾
â”‚   â”‚   â”‚   â”œâ”€â”€ 000947_779.png        # ç›¸å¯¹æ—¶é—´å‘½å
â”‚   â”‚   â”‚   â””â”€â”€ 000953_125.png
â”‚   â”‚   â”œâ”€â”€ processed/                 # å¤„ç†åæ•°æ®
â”‚   â”‚   â”‚   â”œâ”€â”€ events.json            # è§£æå¹¶åˆå¹¶çš„äº‹ä»¶
â”‚   â”‚   â”‚   â””â”€â”€ session_summary.json   # LLMå°±ç»ªæ ¼å¼
â”‚   â”‚   â””â”€â”€ analysis/                  # VLMåˆ†æç»“æœ
â”‚   â”‚       â””â”€â”€ vlm_analysis.json
â”‚   â”‚
â”‚   â””â”€â”€ 20260110_004930_b7d9/          # å¦ä¸€ä¸ªä¼šè¯
â”‚       â””â”€â”€ ...
â”‚
â”œâ”€â”€ master_index.json                  # å…¨å±€ç´¢å¼•æ–‡ä»¶
â””â”€â”€ archive/                           # è¿ç§»æœŸé—´çš„æ—§æ•°æ®å¤‡ä»½
    â”œâ”€â”€ raw/
    â”œâ”€â”€ screenshots/
    â””â”€â”€ processed/
```

---

## å…³é”®æ”¹è¿›

### 1. **ç›´è§‚æ€§**
- âœ… ä¸€ä¸ªä¼šè¯ = ä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œæ‰€æœ‰ç›¸å…³æ–‡ä»¶é›†ä¸­åœ¨ä¸€èµ·
- âœ… æ–‡ä»¶åæ¸…æ™°æè¿°ç”¨é€”ï¼Œæ— å¤æ‚çš„æ—¶é—´æˆ³ç¼–ç 

### 2. **æ˜“æŸ¥æ‰¾**
- âœ… é€šè¿‡æ–‡ä»¶å¤¹åå³å¯çœ‹å‡ºæ—¶é—´ (YYYYMMDD_HHMMSS)
- âœ… é€šè¿‡master_index.jsonå¿«é€Ÿæ£€ç´¢ä¼šè¯
- âœ… æ”¯æŒæ—¶é—´èŒƒå›´ã€æ—¶é—´æˆ³ã€IDç­‰å¤šç§æŸ¥è¯¢æ–¹å¼

### 3. **æ¸…æ™°ç»§æ‰¿**
- âœ… raw â†’ processed â†’ analysis çš„æ•°æ®æµä¸€ç›®äº†ç„¶
- âœ… æ¯ä¸ªé˜¶æ®µçš„æ–‡ä»¶ä½ç½®ä¸€è‡´

### 4. **æ˜“ç»´æŠ¤**
- âœ… åˆ é™¤æ•´ä¸ªä¼šè¯åªéœ€åˆ é™¤ä¸€ä¸ªæ–‡ä»¶å¤¹
- âœ… å½’æ¡£æ—§ä¼šè¯ä¸å½±å“ç³»ç»Ÿæ€§èƒ½
- âœ… å‘åå…¼å®¹æ—§æ•°æ®æ ¼å¼

### 5. **å¯æ‰©å±•**
- âœ… æ‰å¹³ç»“æ„æ”¯æŒæ•°ç™¾ä¸ªä¼šè¯
- âœ… æœªæ¥è½»æ¾åˆ‡æ¢åˆ°æŒ‰æœˆåˆ†å±‚ (data/2026/01/session_xxx/)
- âœ… master_indexæ”¯æŒå¿«é€ŸæŸ¥è¯¢ï¼Œé¿å…æ–‡ä»¶ç³»ç»Ÿç“¶é¢ˆ

---

## ä½¿ç”¨æŒ‡å—

### æ–°å»ºä¼šè¯æ”¶é›†
```python
from src.learning.behavior_analyzer import BehaviorAnalyzer

analyzer = BehaviorAnalyzer()
# è‡ªåŠ¨ä½¿ç”¨æ–°çš„ä¼šè¯ç»“æ„
sessions = analyzer.collect_and_process(duration_seconds=60)
```

### æŸ¥è¯¢ä¼šè¯
```python
from src.learning.utils import (
    get_recent_sessions,
    query_sessions_by_date_range,
    load_session_metadata
)

# è·å–æœ€è¿‘çš„10ä¸ªä¼šè¯
recent = get_recent_sessions("data", n=10)

# æŒ‰æ—¥æœŸèŒƒå›´æŸ¥è¯¢
results = query_sessions_by_date_range(
    "data",
    "2026-01-10T00:00:00Z",
    "2026-01-10T23:59:59Z"
)

# åŠ è½½ä¼šè¯å…ƒæ•°æ®
metadata = load_session_metadata("data", "20260110_153045_a3f2")
```

### è¿ç§»æ—§æ•°æ®
```bash
python scripts/migrate_sessions.py
```

### è¿è¡Œæµ‹è¯•
```bash
python scripts/test_session_organization.py
```

---

## å‘åå…¼å®¹æ€§

âœ… **å®Œå…¨å‘åå…¼å®¹**

- âœ… æ—§çš„æ–‡ä»¶ç»“æ„ä¸å—å½±å“ï¼ˆåœ¨è¿ç§»å‰ï¼‰
- âœ… `detect_session_format()` è‡ªåŠ¨è¯†åˆ«æ ¼å¼ç‰ˆæœ¬
- âœ… VLMAnalyzeråŒæ—¶æ”¯æŒæ—§è·¯å¾„å’Œæ–°è·¯å¾„
- âœ… è¿ç§»è„šæœ¬è‡ªåŠ¨å¤‡ä»½æ—§æ•°æ®

---

## éƒ¨ç½²æ³¨æ„äº‹é¡¹

### ç¬¬ä¸€æ­¥ï¼šè¿è¡Œæµ‹è¯•
```bash
python scripts/test_session_organization.py
```

### ç¬¬äºŒæ­¥ï¼šï¼ˆå¯é€‰ï¼‰è¿ç§»ç°æœ‰æ•°æ®
```bash
python scripts/migrate_sessions.py
```

### ç¬¬ä¸‰æ­¥ï¼šå¼€å§‹ä½¿ç”¨æ–°æ ¼å¼
æ–°çš„BehaviorAnalyzerä¼šè‡ªåŠ¨ä½¿ç”¨æ–°çš„ä¼šè¯ç»“æ„ã€‚

---

## å·²çŸ¥é—®é¢˜å’Œæ³¨æ„äº‹é¡¹

1. **æ—¶é—´æˆ³æ ¼å¼**
   - å†…éƒ¨ä½¿ç”¨ISO 8601 (2026-01-10T15:30:45.123000Z)
   - æ–‡ä»¶åä½¿ç”¨ç´§å‡‘æ ¼å¼ (20260110_153045)
   - ç›¸å¯¹æ—¶é—´ä½¿ç”¨ HHmmSS_mmm.png

2. **å‘ä¸‹å…¼å®¹**
   - migrate_sessions.py å¤„ç†æ—§æ•°æ®æ ¼å¼
   - å»ºè®®åœ¨è¿ç§»å‰å¤‡ä»½åŸå§‹æ•°æ®

3. **æ€§èƒ½**
   - master_index.json é¿å…æ–‡ä»¶ç³»ç»Ÿæ‰«æ
   - æŸ¥è¯¢æ“ä½œO(n)å¤æ‚åº¦ï¼Œä½†né€šå¸¸è¾ƒå°

---

## ä¸‹ä¸€æ­¥æ”¹è¿›æ–¹å‘

1. **æ·»åŠ ä¼šè¯æ ‡ç­¾ç³»ç»Ÿ** - æŒ‰åº”ç”¨ã€æ—¥æœŸã€ç”¨é€”åˆ†ç±»
2. **å®ç°ä¼šè¯å‹ç¼©** - å‹ç¼©åŸå§‹æ—¥å¿—æ–‡ä»¶èŠ‚çœç©ºé—´
3. **å¢é‡å¤‡ä»½** - è‡ªåŠ¨å¤‡ä»½æ–°ä¼šè¯åˆ°äº‘å­˜å‚¨
4. **Webç•Œé¢** - æµè§ˆå’Œç®¡ç†ä¼šè¯çš„UI
5. **åˆ†æä»ªè¡¨æ¿** - ç»Ÿè®¡åˆ†æä¼šè¯æ•°æ®çš„è¶‹åŠ¿

---

**å®ç°å®Œæ¯•ï¼** ğŸ‰

æ–°çš„æ–‡ä»¶ç»„ç»‡ç³»ç»Ÿå·²ç»å‡†å¤‡å°±ç»ªã€‚æ‰€æœ‰å­¦ä¹ æ¨¡å—çš„ä»£ç éƒ½å·²æ›´æ–°ä»¥æ”¯æŒæ–°ç»“æ„ï¼ŒåŒæ—¶ä¿æŒä¸æ—§æ•°æ®çš„å…¼å®¹æ€§ã€‚
