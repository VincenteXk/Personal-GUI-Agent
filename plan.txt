flowchart TD

%% ----------------- NODES -----------------
ON0["首次打开 / Onboarding"]
ON1["能力边界 + 风险提示 <br>不自动支付/不自动删除；不主动发信息(任务前确认）"]
ON2["权限与连接引导 <br>APP信息获取/屏幕录制（可跳过），让用户取消不想给权限的APP<br>截屏、直接操控、输入、麦克风（必须有）<br>可选：位置信息（默认同意/每次使用时选）"]
ON3["创建初始画像（可编辑）<br>语言风格/常用App/默认模式"]
ON4["初始化偏好 <br>购物场景，如外卖/打车/网购：价格/位置/时间/APP偏好，<br>社交动作：点赞率/评论率/收藏/信息语气偏好）（可细化去子场景定义、可跳过）"]
ON5["允许记住每次任务的偏好？<br>默认更新/仅本次"]
HOME["Home：一句话去做 / 修改偏好"]

A["用户输入指令<br>语音/文本"]
B["指令标准化<br>任务类型/关键信息项/约束"]
B1{"缺关键信息项？"}
B2["最小追问（2–4选项）<br>只问缺的"]

C["设备连接与环境检测<br>ADB/HDC/WDA"]
D{"设备状态正常？"}
E["提示修复状态\n解锁/USB调试/授权"]

P0["Plan Preview：计划预览 <br>任务+App+模式"]
P1{"用户选择？"}
P2["换一种做法（第二模式） <br>默认/备用策略"]

F["UI屏幕感知<br>截图+多模态解析"]
G["生成分步操作序列 <br>Launch/Tap/Type/Swipe"]
H{"是否敏感/模糊/不可逆？"}

L["执行当前操作"]
M["执行后校验 <br>关键页面/关键文案"]
N{"操作成功？"}
O{"重试次数≥3？"}
P["请求人工接管 <br>给出卡住原因+手动一步"]
Q{"任务完成？"}
R["输出结构化结果 <br>列表/已完成动作"]
S["结束 + 记录日志 <br>回放/撤销/失败原因"]

%% HITL 场景
I0["触发人机交互（HITL） <br>展示候选+解释理由+确认"]
S1{"人工交互场景类型？"}

I1["外卖/下单前确认 <br>店铺/商品/规格/数量/地址"]
I1a{"能明确选中一个吗？"}
I1b["是否满意？不满意展示其他选项对比卡片（精简语音确认） / 用户自己加入信息明确修改"]
I2["停在提交订单/确认页 <br>不做真实支付"]

W1["微信/邮件发送前确认 <br>收件人/内容/语气"]
W2{"是否高风险内容？ <br>转账红包金额/隐私/群聊"}
W3["二次确认 + 风险点提示 <br>可改写更稳妥版本"]
W4["执行发送"]

D1["删除前确认\n数量/范围 <br>默认：整理不删"]
D2{"用户确认删除？"}
D3["安全替代<br>移入文件夹/标记待删"]
D4["执行删除（若允许）"]

IU["执行后反馈弹窗<br>符合习惯吗？"]
J{"是否更新画像？"}
K["写入画像<br>全局/场景/App/联系人<br>置信度+可撤销"]
L2["不更新画像<br>仅本次"]

%% ----------------- EDGES -----------------
ON0 --> ON1 --> ON2 --> ON3 --> ON4 --> ON5 --> HOME

HOME --> A --> B --> B1
B1 -- 是 --> B2 --> B
B1 -- 否 --> C

C --> D
D -- 否 --> E --> C
D -- 是 --> P0

P0 --> P1
P1 -- 开始执行 --> F
P1 -- 换一种做法 --> P2 --> P0
P1 -- 补充条件 --> B2

F --> G --> H
H -- 否 --> L --> M
H -- 是 --> I0 --> S1

S1 -- 外卖/下单 --> I1 --> I1a
I1a -- 否 --> I1b --> I1
I1a -- 是 --> I2 --> IU

S1 -- 微信聊天/发消息 --> W1 --> W2
W2 -- 是 --> W3 --> W1
W2 -- 否 --> W4 --> IU

S1 -- 删除/清理 --> D1 --> D2
D2 -- 否 --> D3 --> IU
D2 -- 是 --> D4 --> IU

IU --> J
J -- 是 --> K --> M
J -- 否 --> L2 --> M

M --> N
N -- 否 --> O
O -- 否 --> F
O -- 是 --> P --> S
N -- 是 --> Q
Q -- 否 --> F
Q -- 是 --> R --> S

%% ----------------- COLOR STYLES -----------------
classDef ui fill:#D6EAF8,stroke:#2874A6,stroke-width:1px,color:#0B2F4A;
classDef exec fill:#D5F5E3,stroke:#1E8449,stroke-width:1px,color:#0B3D1E;
classDef risk fill:#FADBD8,stroke:#C0392B,stroke-width:1px,color:#641E16;
classDef memory fill:#E8DAEF,stroke:#7D3C98,stroke-width:1px,color:#3B1B4A;

%% UI / Onboarding / 选择题
class ON0,ON1,ON2,HOME,A,B,B1,B2,P0,P1,P2, ui;

%% 执行主链
class C,D,E,F,G,L,L2,M,N,Q,R,S,W2,D2,I1a,I1b,W3,D2,D3,D4,W4 exec;

%% 风控/人工接管/重试
class H,O,P,I0,S1,I1,I2,W1,D1, risk;

%% 画像与写入
class J,K,ON3,ON4,ON5,IU memory;